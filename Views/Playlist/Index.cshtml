@model IEnumerable<MusicPlayerWeb.Models.ViewModels.PlaylistViewModel>

@{
    ViewData["Title"] = "Playlists";
}

<style>
    /* --- HEADER AREA --- */
    .playlist-header-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    /* Search Bar Custom */
    .search-input-group {
        position: relative;
        width: 300px;
    }
    .search-input-group input {
        background-color: #2A3550;
        border: 1px solid #3E4C6E;
        color: white;
        border-radius: 20px;
        padding: 8px 15px 8px 35px;
        width: 100%;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
    }
    .search-input-group input:focus {
        border-color: var(--accent-color);
    }
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6F7A95;
        font-size: 14px;
    }

    /* Button New Playlist */
    .btn-new-playlist {
        background-color: #5CD1FF;
        color: #151C30;
        border-radius: 20px;
        padding: 8px 20px;
        font-weight: bold;
        font-size: 14px;
        border: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.1s;
    }
    .btn-new-playlist:hover {
        transform: scale(1.05);
        background-color: #f0f0f0;
    }

        .btn-submit:hover {
            transform: scale(1.05);
            background-color: #f0f0f0 !important;
        }

    /* --- PLAYLIST CARD --- */
    .playlist-card {
        background-color: #1B2338;
        padding: 16px;
        border-radius: 8px;
        transition: background-color 0.3s;
        cursor: pointer;
        display: block;
        text-decoration: none;
        height: 100%;
    }
    .playlist-card:hover {
            background-color: #2A3550;
    }

    /* --- COVER IMAGE LOGIC (Grid vs Single) --- */
    .cover-container {
        width: 100%;
        aspect-ratio: 1 / 1; /* Kotak Sempurna */
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 16px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        position: relative;
        background-color: #333;
    }

    /* Tipe 1: Collage 2x2 (Jika lagu >= 4) */
    .cover-collage {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        width: 100%;
        height: 100%;
    }
    .cover-collage img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Tipe 2: Single Image (Jika lagu 1-3 atau Custom) */
    .cover-single {
        width: 100%;
        height: 100%;
    }
    .cover-single img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Tipe 3: Placeholder (Jika kosong) */
    .cover-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #2A3550;
        color: #6F7A95;
    }
    .cover-placeholder svg {
        width: 50%;
        height: 50%;
        fill: currentColor;
    }

    /* Text */
    .pl-title {
        color: white;
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .pl-desc {
        color: #AEB7D3;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .btn-hover-accent {
        transition: color 0.2s;
    }

        .btn-hover-accent:hover {
            color: #5CD1FF !important; /* Warna berubah jadi biru saat di-hover */
        }
</style>

<div class="playlist-header-area">
    <div class="search-input-group">
        <span class="search-icon">🔍</span>
        <input type="text" id="playlistSearch" placeholder="Search playlists..." value="@ViewBag.SearchQuery"
               onkeydown="if(event.key === 'Enter') searchPlaylists(this.value)">
    </div>

    <button class="btn-new-playlist" onclick="createNewPlaylistPrompt()">
        <span>+</span> New Playlist
    </button>
</div>

<div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4">
    @foreach (var pl in Model)
    {
        <div class="col">
            <a href="/Playlist/Details/@pl.Id" class="playlist-card ajax-link">

                <div class="cover-container">
                    @if (!string.IsNullOrEmpty(pl.CustomCoverPath))
                    {
                        // 1. CUSTOM COVER (Prioritas Utama)
                        <div class="cover-single">
                            <img src="@pl.CustomCoverPath" onerror="this.src='https://via.placeholder.com/200?text=Error';" />
                        </div>
                    }
                    else if (pl.ThumbnailSongIds.Count >= 4)
                    {
                        // 2. COLLAGE 4 GAMBAR (Spotify Style)
                        <div class="cover-collage">
                            @foreach (var songId in pl.ThumbnailSongIds)
                            {
                                <img src="/Music/GetAlbumArt/@songId" onerror="this.src='https://via.placeholder.com/100?text=♪';" />
                            }
                        </div>
                    }
                    else if (pl.ThumbnailSongIds.Count > 0)
                    {
                        // 3. SINGLE IMAGE (Jika lagu 1, 2, atau 3) - Ambil lagu pertama
                        <div class="cover-single">
                            <img src="/Music/GetAlbumArt/@pl.ThumbnailSongIds[0]" onerror="this.src='https://via.placeholder.com/200?text=♪';" />
                        </div>
                    }
                    else
                    {
                        // 4. PLACEHOLDER (Playlist Kosong)
                        <div class="cover-placeholder">
                            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" /></svg>
                        </div>
                    }
                </div>

                <div class="pl-title">@pl.Name</div>
                <div class="pl-desc">@pl.SongCount songs</div>
            </a>
        </div>
    }
</div>

<div class="modal fade" id="createPlaylistModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1B2338; color: white; border: 1px solid #3E4C6E;">

            <div class="modal-header" style="border-bottom: 1px solid #3E4C6E;">
                <h5 class="modal-title fw-bold" id="createModalLabel">Create Playlist</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form action="/Playlist/Create" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="d-flex gap-3">
                        <div class="position-relative group-upload" style="width: 150px; height: 150px; min-width: 150px;">
                            <input type="file" name="coverImage" id="coverImageInput" accept="image/*" style="display: none;" onchange="previewImage(event)">

                            <div id="imagePreviewArea"
                                 onclick="document.getElementById('coverImageInput').click();"
                                 class="d-flex align-items-center justify-content-center shadow-sm"
                                 style="width: 100%; height: 100%; background-color: #151C30; border-radius: 4px; cursor: pointer; border: 2px dashed #3E4C6E; overflow: hidden; transition: 0.2s;">

                                <div id="placeholderIcon" class="text-center text-secondary">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #6F7A95; margin-bottom: 4px;">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" opacity="0" />
                                        <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z M12 9c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z" />
                                    </svg>
                                    <div style="font-size: 11px; font-weight: 600;">Choose Photo</div>
                                </div>

                                <img id="imgPreview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;" />
                            </div>
                        </div>

                        <div class="flex-grow-1">
                            <div class="mb-3">
                                <label for="playlistName" class="form-label text-secondary small fw-bold">Name</label>
                                <input type="text" name="name" class="form-control" id="playlistName"
                                       placeholder="@ViewBag.SuggestedName" required
                                       style="background-color: #2A3550; border: none; color: white; font-weight: bold;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="border-top: none;">
                    <button type="button" class="btn btn-transparent text-white fw-bold btn-hover-accent" data-bs-dismiss="modal">Close</button>

                    <button type="submit" class="btn btn-submit rounded-pill px-4 fw-bold"
                            style="background-color: #5CD1FF; color: #1B2338; border: none;">
                        Save
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<script>
    function searchPlaylists(query) {
        // 1. Buat URL dengan parameter search
        // encodeURIComponent penting agar karakter spasi/simbol tidak merusak URL
        const url = '/Playlist/Index?search=' + encodeURIComponent(query);

        // 2. Panggil fungsi loadPage() milik _Layout.cshtml
        // Ini akan me-load ulang area konten utama saja (Partial View)
        if (typeof loadPage === 'function') {
            loadPage(url);
        } else {
            // Fallback jika loadPage error (jarang terjadi)
            window.location.href = url;
        }
    }

    // kursor tetap di akhir teks setelah reload
    // Cek jika ada value di search box, fokuskan kembali
    document.addEventListener("DOMContentLoaded", function() {
        var searchBox = document.getElementById("playlistSearch");
        if (searchBox && searchBox.value) {
            searchBox.focus();
            // Pindahkan kursor ke paling belakang
            var val = searchBox.value;
            searchBox.value = '';
            searchBox.value = val;
        }
    });

    // 1. Fungsi Buka Modal (Menggantikan Prompt Lama)
    function createNewPlaylistPrompt() {
        // Ambil elemen input
        var inputName = document.getElementById('playlistName');

        // Kosongkan value agar placeholder terlihat
        inputName.value = "";
        // Reset Form
        document.getElementById('playlistName').value = "";
        document.getElementById('coverImageInput').value = "";

        // Reset Preview
        document.getElementById('imgPreview').src = "";
        document.getElementById('imgPreview').style.display = 'none';
        document.getElementById('placeholderIcon').style.display = 'block';
        document.getElementById('imagePreviewArea').style.border = '2px dashed #3E4C6E';

        // Tampilkan Modal Bootstrap
        var myModal = new bootstrap.Modal(document.getElementById('createPlaylistModal'));
        myModal.show();
    }

    // 2. Fungsi Preview Gambar saat dipilih
    function previewImage(event) {
        var reader = new FileReader();
        reader.onload = function () {
            var output = document.getElementById('imgPreview');
            var placeholder = document.getElementById('placeholderIcon');
            var area = document.getElementById('imagePreviewArea');

            output.src = reader.result;
            output.style.display = 'block';
            placeholder.style.display = 'none';
            area.style.border = 'none'; // Hilangkan garis putus-putus
        }
        if (event.target.files[0]) {
            reader.readAsDataURL(event.target.files[0]);
        }
    }
</script>