@model MusicPlayerWeb.Models.ViewModels.PlaylistDetailViewModel

@{
    ViewData["Title"] = Model.Name;
}

<style>
    /* --- HEADER SECTION (Hero Style) --- */
    .playlist-header-container {
        background: linear-gradient(180deg, #404E70 0%, #1F2945 100%);
        padding: 30px;
        display: flex;
        align-items: flex-end;
        gap: 25px;
        height: 300px;
        margin: -24px -24px 20px -24px;
    }

    /* --- COVER BOX (Header) --- */
    .detail-cover-box {
        width: 232px;
        height: 232px;
        min-width: 232px;
        box-shadow: 0 4px 60px rgba(0,0,0,0.5);
        background-color: #282828;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    /* --- TEXT INFO --- */
    .playlist-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }

    .playlist-label {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        color: white;
        margin-bottom: 8px;
    }

    .playlist-title-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }

    .playlist-title {
        font-size: 60px;
        font-weight: 800;
        color: white;
        line-height: 1;
        margin: 0;
        letter-spacing: -2px;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: 800px;
    }

    .cover-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #2A3550;
        color: #6F7A95;
    }

        .cover-placeholder svg {
            width: 50%;
            height: 50%;
            fill: currentColor;
        }

    .btn-edit-title {
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.7);
        cursor: pointer;
        transition: color 0.2s;
        padding: 0;
    }

        .btn-edit-title:hover {
            color: white;
        }

        .btn-edit-title svg {
            width: 24px;
            height: 24px;
        }

    .playlist-meta {
        font-size: 14px;
        font-weight: 600;
        color: rgba(255,255,255,0.7);
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .playlist-meta span.highlight {
            color: white;
        }

    /* --- ACTION BAR --- */
    .action-bar {
        padding: 20px 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        position: sticky;
        top: -24px;
        background-color: #1F2945;
        z-index: 10;
        margin-left: -24px;
        margin-right: -24px;
    }

    .btn-play-circle {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background-color: #5CD1FF;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.1s, background-color 0.2s;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }

        .btn-play-circle:hover {
            transform: scale(1.05);
            background-color: #82DFFF;
        }

        .btn-play-circle svg {
            width: 40px;
            height: 40px;
            margin: 0;
            fill: #151C30;
        }

    .btn-shuffle {
        background: transparent;
        border: none;
        color: #AEB7D3;
        cursor: default;
        opacity: 0.6;
        transition: color 0.2s, opacity 0.2s;
        margin-right: 10px;
    }

    .btn-pill {
        background: transparent;
        border: 1px solid #6F7A95;
        color: white;
        padding: 8px 24px;
        font-size: 14px;
        border-radius: 30px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .btn-pill-primary:hover {
        background-color: #5CD1FF;
        border-color: #5CD1FF;
        color: #151C30;
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(92, 209, 255, 0.4);
    }

    .btn-pill-danger {
        border-color: #EF4444;
        color: #EF4444;
    }

        .btn-pill-danger:hover {
            background-color: #EF4444;
            color: white;
            border-color: #EF4444;
            transform: scale(1.05);
        }

    /* --- SEARCH BAR STYLE --- */
    .search-input-group {
        position: relative;
        width: 100%;
    }

        .search-input-group input {
            background-color: #151C30 !important;
            border: 1px solid #3E4C6E;
            color: white;
            border-radius: 20px;
            padding: 8px 15px 8px 35px;
            width: 100%;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

            .search-input-group input:focus {
                border-color: #5CD1FF;
            }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6F7A95;
        font-size: 14px;
        pointer-events: none;
    }

    /* --- LIST LAGU (Fixed Style) --- */
    .detail-song-list {
        padding: 0 10px;
    }

    .song-list-item {
        display: grid;
        grid-template-columns: 65px 1fr 100px 40px;
        align-items: center;
        padding: 10px 0; /* WPF Padding="10" */
        margin-bottom: 8px;
        background-color: #2A3550; /* KOREKSI: HARUS WARNA INI, BUKAN TRANSPARENT */

        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
        border-left: 2px solid transparent;
    }

        .song-list-item:hover {
            background-color: #36405F;
        }

        .song-list-item.active {
            background-color: #3E4C6E; /* Background Selected */
            border-left-color: #5CD1FF; /* Garis Biru di Kiri */
        }

    /* Cover Box */
    .list-cover-box {
        width: 48px;
        height: 48px;
        background-color: #2A3550;
        border: 1px solid #3E4C6E;
        border-radius: 8px;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    /* Icon Placeholder (SVG Path from XAML) */
    .list-placeholder-icon {
        width: 22px;
        height: 22px;
        fill: #586380;
        opacity: 0.7;
    }

    /* Text Styles */
    .list-title {
        color: white;
        font-weight: 600;
        font-size: 14px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .list-artist {
        color: #AEB7D3;
        font-size: 12px;
        margin-top: 2px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .list-duration {
        color: #6F7A95;
        font-size: 13px;
        font-weight: 500;
        text-align: right;
        margin-right: 20px;
    }

    /* Context Menu Button (KEMBALI KE TITIK TIGA) */
    .btn-more {
        background: transparent;
        border: none;
        color: #6F7A95;
        font-weight: bold;
        font-size: 18px;
        width: 40px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .btn-more:hover {
            color: white;
        }

    /* Tombol Add Selected Biru */
    .btn-submit-primary {
        background-color: #5CD1FF !important;
        color: #151C30 !important;
        border: none;
        padding: 6px 20px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 14px;
        transition: transform 0.1s;
    }

        .btn-submit-primary:hover {
            transform: scale(1.05);
            background-color: #82DFFF !important;
        }

    /* --- ADD SONG MODAL --- */
    .modal-song-list {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 10px;
    }

        .modal-song-list::-webkit-scrollbar {
            width: 6px;
        }

        .modal-song-list::-webkit-scrollbar-thumb {
            background: #3E4C6E;
            border-radius: 3px;
        }

    .select-song-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #2A3550;
    }

        .select-song-item:hover {
            background-color: #2A3550;
        }

    .custom-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #6F7A95;
        border-radius: 4px;
        margin-right: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .select-song-item.selected .custom-checkbox {
        background-color: #5CD1FF;
        border-color: #5CD1FF;
    }

    .custom-checkbox::after {
        content: '✓';
        color: #1B2338;
        font-weight: bold;
        font-size: 14px;
        display: none;
    }

    .select-song-item.selected .custom-checkbox::after {
        display: block;
    }

    /* Hover Overlay */
    .image-hover-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 10;
        border-radius: 4px;
        color: white;
        pointer-events: none;
    }

    .upload-area:hover .image-hover-overlay {
        opacity: 1;
    }

    .upload-area:hover {
        border-color: #5CD1FF !important;
    }

</style>

<div class="playlist-header-container">
    <div class="detail-cover-box">
        @if (!string.IsNullOrEmpty(Model.CustomCoverPath))
        {
            <img src="@Model.CustomCoverPath" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/232?text=Error';" />
        }
        else if (Model.ThumbnailSongIds != null && Model.ThumbnailSongIds.Count >= 4)
        {
            <div style="display:grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; width:100%; height:100%;">
                @foreach (var sid in Model.ThumbnailSongIds)
                {
                    <img src="/Music/GetAlbumArt/@sid" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/116?text=♪';" />
                }
            </div>
        }
        else if (Model.ThumbnailSongIds != null && Model.ThumbnailSongIds.Count > 0)
        {
            <img src="/Music/GetAlbumArt/@Model.ThumbnailSongIds[0]" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/232?text=♪';" />
        }
        else
        {
            <div class="cover-placeholder">
                <svg viewBox="0 0 24 24">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                </svg>
            </div>
        }
    </div>

    <div class="playlist-info">
        <div class="playlist-label">Playlist</div>
        <div class="playlist-title-row">
            <h1 class="playlist-title" id="playlistNameDisplay">@Model.Name</h1>
            <button class="btn-edit-title" onclick="renamePlaylistPrompt(@Model.Id, '@Model.Name')" title="Rename Playlist">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
        </div>
        <div class="playlist-meta">
            <span class="highlight"> @Model.SongCount songs
        </div>
    </div>
</div>

<div class="action-bar">
    <button class="btn-play-circle" onclick="playAllSongsInPlaylist()">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
    </button>
    <button class="btn-shuffle" title="Shuffle (Coming Soon)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width:24px; height:24px; fill:currentColor;">
            <path d="M403.8 34.4c12-5 25.7-2.2 34.9 6.9l64 64c6 6 9.4 14.1 9.4 22.6s-3.4 16.6-9.4 22.6l-64 64c-9.2 9.2-22.9 11.9-34.9 6.9S384 204.9 384 192l0-32-32 0c-10.1 0-19.6 4.7-25.6 12.8l-32.4 43.2-40-53.3 21.2-28.3C293.3 110.2 321.8 96 352 96l32 0 0-32c0-12.9 7.8-24.6 19.8-29.6zM154 296l40 53.3-21.2 28.3C154.7 401.8 126.2 416 96 416l-64 0c-17.7 0-32-14.3-32-32s14.3-32 32-32l64 0c10.1 0 19.6-4.7 25.6-12.8L154 296zM438.6 470.6c-9.2 9.2-22.9 11.9-34.9 6.9S384 460.9 384 448l0-32-32 0c-30.2 0-58.7-14.2-76.8-38.4L121.6 172.8c-6-8.1-15.5-12.8-25.6-12.8l-64 0c-17.7 0-32-14.3-32-32S14.3 96 32 96l64 0c30.2 0 58.7 14.2 76.8 38.4L326.4 339.2c6 8.1 15.5 12.8 25.6 12.8l32 0 0-32c0-12.9 7.8-24.6 19.8-29.6s25.7-2.2 34.9 6.9l64 64c6 6 9.4 14.1 9.4 22.6s-3.4 16.6-9.4 22.6l-64 64z" />
        </svg>
    </button>
    <button class="btn-pill btn-pill-primary" onclick="openAddSongsModal(@Model.Id)">
        <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;">
            <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z" />
        </svg>
        Add Songs
    </button>
    <button class="btn-pill btn-pill-primary" onclick="openEditModal()">
        <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
        </svg>
        Edit
    </button>
    <form action="/Playlist/Delete/@Model.Id" method="post" onsubmit="return confirm('Delete this playlist?');" style="margin:0;">
        <button type="submit" class="btn-pill btn-pill-danger">
            <svg viewBox="0 0 24 24" style="width:18px; height:18px; fill:currentColor;">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
            </svg>
            Delete
        </button>
    </form>
</div>

<div class="detail-song-list">
    @if (Model.Songs != null && Model.Songs.Any())
    {
        @foreach (var song in Model.Songs)
        {
            <div class="song-list-item"
                 data-id="@song.Id"
                 data-title="@song.Title"
                 data-artist="@(song.Artist?.Name ?? "Unknown")"
                 data-cover="/Music/GetAlbumArt/@song.Id"
                 data-url="/Music/PlayStream?id=@song.Id"
                 onclick="playFromQueue(this)"
                 oncontextmenu="openSongMenu(event, @song.Id, @(song.IsLiked.ToString().ToLower()), true)">
                <div style="padding-left: 10px;">
                    <div class="list-cover-box">
                        <img src="/Music/GetAlbumArt/@song.Id"
                             style="width: 100%; height: 100%; object-fit: cover;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                        <svg class="list-placeholder-icon" viewBox="0 0 24 24" style="display:none;">
                            <path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z" />
                        </svg>
                    </div>
                </div>

                <div style="overflow: hidden;" class="ms-2">
                    <span class="list-title">@song.Title</span>
                    <span class="list-artist">@(song.Artist?.Name ?? "Unknown Artist")</span>
                </div>

                <div class="list-duration">
                    @TimeSpan.FromSeconds(song.Duration).ToString(@"mm\:ss")
                </div>

                <div>
                    <button class="btn-more" onclick="openSongMenu(event, @song.Id, @(song.IsLiked.ToString().ToLower()), true)">⋮</button>
                </div>
            </div>
        }
    }
    else
    {
        <div style="color: #6F7A95; padding: 50px; text-align:center;">
            <div style="font-size: 40px; margin-bottom: 10px;">🎵</div>
            <div>This playlist is empty.</div>
        </div>
    }
</div>

<div class="modal fade" id="addSongsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background-color: #1B2338; color: white; border: 1px solid #3E4C6E;">
            <div class="modal-header" style="border-bottom: 1px solid #3E4C6E;">
                <h5 class="modal-title fw-bold">Add Songs to Playlist</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="search-input-group">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="addSongSearch" placeholder="Search available songs..." onkeyup="fetchAvailableSongs(this.value)">
                </div>
                <div id="addSongsListContainer" class="modal-song-list">
                    <div class="text-center text-secondary py-4">Loading songs...</div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #3E4C6E;">
                <div class="me-auto text-secondary" style="font-size:13px;">
                    <span id="selectedCount">0</span> selected
                </div>
                <button type="button" class="btn btn-transparent text-white fw-bold btn-hover-accent" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-submit-primary" onclick="submitSelectedSongs()">Add Selected</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPlaylistModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #1B2338; color: white; border: 1px solid #3E4C6E;">
            <div class="modal-header" style="border-bottom: 1px solid #3E4C6E;">
                <h5 class="modal-title fw-bold">Edit Playlist</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/Playlist/Update" method="post" enctype="multipart/form-data">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="modal-body">
                    <div class="d-flex gap-3">
                        <div class="position-relative group-upload" style="width: 150px; height: 150px; min-width: 150px;">
                            <input type="file" name="coverImage" id="editCoverInput" accept="image/*" style="display: none;" onchange="previewEditImage(event)">
                            <div id="editImageArea" class="upload-area" onclick="document.getElementById('editCoverInput').click()" style="width: 100%; height: 100%; background-color: #151C30; border-radius: 4px; cursor: pointer; border: 2px dashed #3E4C6E; overflow: hidden; transition: 0.2s; position: relative;">
                                <img id="editImgPreview" src="@(string.IsNullOrEmpty(Model.CustomCoverPath) ? "" : Model.CustomCoverPath)" style="width: 100%; height: 100%; object-fit: cover; display: @(string.IsNullOrEmpty(Model.CustomCoverPath) ? "none" : "block");" />
                                <div id="editPlaceholder" class="text-center text-secondary" style="display: @(string.IsNullOrEmpty(Model.CustomCoverPath) ? "flex" : "none"); flex-direction:column; align-items:center; justify-content:center; height:100%;">
                                    <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; fill: #6F7A95; margin-bottom: 4px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" opacity="0" /><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z M12 9c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z" /></svg>
                                    <div style="font-size: 11px; font-weight: 600;">Upload Photo</div>
                                </div>
                                <div class="image-hover-overlay">
                                    <svg viewBox="0 0 24 24" style="width:28px; height:28px; fill:white; margin-bottom:5px;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" /></svg>
                                    <span style="font-size: 12px; font-weight: 700;">Ganti Cover</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="mb-3">
                                <label class="form-label text-secondary small fw-bold">Name</label>
                                <input type="text" name="name" class="form-control" value="@Model.Name" required style="background-color: #2A3550; border: none; color: white; font-weight: bold;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: none;">
                    <button type="button" class="btn btn-transparent text-white fw-bold btn-hover-accent" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-submit rounded-pill px-4 fw-bold" style="background-color: #5CD1FF; color: #1B2338; border: none;">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- VARIABEL GLOBAL ---
    // Gunakan 'var' (bukan const) agar aman saat reload script parsial
    var activePlaylistId = @Model.Id;
    var selectedSongIds = new Set();

    // --- FUNGSI HEADER (Rename, Play, Edit) ---
    function renamePlaylistPrompt(id, currentName) {
        let newName = prompt("Rename playlist:", currentName);
        if (newName != null && newName.trim() !== "" && newName !== currentName) {
            fetch('/Playlist/Rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'id=' + id + '&newName=' + encodeURIComponent(newName)
            }).then(res => {
                if (res.ok) document.getElementById('playlistNameDisplay').innerText = newName;
            });
        }
    }

    // Fungsi Remove Helper untuk Context Menu
    // Dipanggil dari _Layout.cshtml (menuAction -> remove)
    function removeFromPlaylistContext(songId) {
        if(!confirm("Remove this song from playlist?")) return;
        fetch('/Playlist/RemoveSong', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'playlistId=' + activePlaylistId + '&songId=' + songId
        }).then(res => {
            if (res.ok) loadPage('/Playlist/Details/' + activePlaylistId);
        });
    }

    function playAllSongsInPlaylist() {
        const firstSong = document.querySelector('.song-list-item');
        if (firstSong) playFromQueue(firstSong);
    }

    function openEditModal() {
        var myModal = new bootstrap.Modal(document.getElementById('editPlaylistModal'));
        myModal.show();
    }

    function previewEditImage(event) {
        var reader = new FileReader();
        reader.onload = function () {
            var output = document.getElementById('editImgPreview');
            var placeholder = document.getElementById('editPlaceholder');
            output.src = reader.result;
            output.style.display = 'block';
            placeholder.style.display = 'none';
        }
        if (event.target.files[0]) {
            reader.readAsDataURL(event.target.files[0]);
        }
    }

    // --- FUNGSI ADD SONGS ---

    function openAddSongsModal(id) {
        activePlaylistId = id;
        var myModal = new bootstrap.Modal(document.getElementById('addSongsModal'));
        myModal.show();
        selectedSongIds.clear();
        updateSelectedCount();
        document.getElementById('addSongSearch').value = '';
        fetchAvailableSongs();
    }

    function fetchAvailableSongs(query = "") {
        const container = document.getElementById('addSongsListContainer');
        fetch(`/Playlist/GetAvailableSongs?playlistId=${activePlaylistId}&query=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = "";
                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center text-secondary py-4">No songs found available to add.</div>';
                    return;
                }
                data.forEach(song => {
                    const isSelected = selectedSongIds.has(song.id);
                    const selectedClass = isSelected ? 'selected' : '';
                    const html = `
                        <div class="select-song-item ${selectedClass}" onclick="toggleSelectSong(this, ${song.id})">
                            <div class="custom-checkbox"></div>
                            <div style="flex:1; overflow:hidden;">
                                <div style="font-weight:600; font-size:14px; color:white;">${song.title}</div>
                                <div style="font-size:12px; color:#AEB7D3;">${song.artistName}</div>
                            </div>
                            <div style="font-size:12px; color:#6F7A95;">${song.duration}</div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            });
    }

    function toggleSelectSong(element, songId) {
        if (selectedSongIds.has(songId)) {
            selectedSongIds.delete(songId);
            element.classList.remove('selected');
        } else {
            selectedSongIds.add(songId);
            element.classList.add('selected');
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        document.getElementById('selectedCount').innerText = selectedSongIds.size;
    }

    function submitSelectedSongs() {
        if (selectedSongIds.size === 0) {
            alert("Please select at least one song.");
            return;
        }

        let formData = new URLSearchParams();
        formData.append('playlistId', activePlaylistId);
        selectedSongIds.forEach(id => formData.append('songIds', id));

        fetch('/Playlist/AddSongsToPlaylist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        }).then(res => {
            if (res.ok) {
                const modalEl = document.getElementById('addSongsModal');
                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                if (modalInstance) modalInstance.hide();
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                document.body.classList.remove('modal-open');
                document.body.style = "";
                loadPage('/Playlist/Details/' + activePlaylistId);
            } else {
                alert("Failed to add songs.");
            }
        });
    }
</script>